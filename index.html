<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FATISCO - Premium Cold Email Tool</title>
<style>
:root {
  --primary: #00d4ff;
  --primary-dark: #00a8cc;
  --secondary: #ff006e;
  --accent: #ffbe0b;
  --success: #06ffa5;
  --warning: #ff9500;
  --error: #ff3b6d;
  --bg-light: #f0f4f8;
  --bg-dark: #0a0e27;
  --card-light: #ffffff;
  --card-dark: #1a1f3a;
  --text-light: #1e293b;
  --text-dark: #e2e8f0;
  --border-light: #cbd5e1;
  --border-dark: #2d3548;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-light);
  color: var(--text-light);
  transition: all 0.3s ease;
  line-height: 1.5;
  overflow-x: hidden;
}

body.dark {
  background: var(--bg-dark);
  color: var(--text-dark);
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 15px;
}

header {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  margin-bottom: 25px;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  width: 50px;
  height: 50px;
  background: white;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 22px;
  color: var(--primary);
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.logo-text {
  font-size: 26px;
  font-weight: 900;
  letter-spacing: -0.5px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.tagline {
  font-size: 12px;
  opacity: 0.95;
  margin-top: 3px;
}

.theme-toggle {
  background: rgba(255,255,255,0.25);
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  color: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.3s;
  backdrop-filter: blur(10px);
  white-space: nowrap;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.theme-toggle:hover {
  background: rgba(255,255,255,0.35);
  transform: scale(1.05);
}

.top-notification {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, var(--error), #ff1744);
  color: white;
  padding: 12px 20px;
  text-align: center;
  font-weight: 600;
  font-size: 14px;
  transform: translateY(-100%);
  transition: transform 0.4s ease;
  z-index: 9999;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.top-notification.show {
  transform: translateY(0);
}

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}

.stat-card {
  background: var(--card-light);
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  transition: all 0.3s;
  border: 2px solid transparent;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.dark .stat-card {
  background: var(--card-dark);
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  border-color: var(--primary);
}

.stat-label {
  font-size: 11px;
  text-transform: uppercase;
  opacity: 0.7;
  margin-bottom: 8px;
  font-weight: 700;
  letter-spacing: 1px;
}

.stat-value {
  font-size: 32px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.card {
  background: var(--card-light);
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid var(--border-light);
  margin-bottom: 20px;
  transition: all 0.3s;
}

.dark .card {
  background: var(--card-dark);
  border-color: var(--border-dark);
  box-shadow: 0 4px 25px rgba(0,0,0,0.3);
}

.card:hover {
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--primary);
}

.card-icon {
  font-size: 24px;
}

label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 13px;
  opacity: 0.85;
}

input, textarea, select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border-light);
  border-radius: 10px;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.3s;
  background: var(--bg-light);
  color: var(--text-light);
  margin-bottom: 15px;
}

.dark input, .dark textarea, .dark select {
  background: var(--bg-dark);
  border-color: var(--border-dark);
  color: var(--text-dark);
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.15);
  transform: translateY(-1px);
}

.file-upload {
  margin-bottom: 15px;
}

.file-upload input[type=file] {
  display: none;
}

.file-upload-label {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 18px;
  background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(255,0,110,0.1));
  border: 2px dashed var(--primary);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
  font-weight: 600;
}

.file-upload-label:hover {
  background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(255,0,110,0.2));
  transform: scale(1.02);
}

.format-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  background: var(--bg-light);
  padding: 5px;
  border-radius: 10px;
}

.dark .format-selector {
  background: var(--bg-dark);
}

.format-btn {
  flex: 1;
  padding: 10px;
  background: transparent;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.3s;
  margin: 0;
}

.format-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-color: transparent;
}

.html-toolbar {
  display: none;
  gap: 5px;
  margin-bottom: 10px;
  flex-wrap: wrap;
  padding: 10px;
  background: var(--bg-light);
  border-radius: 10px;
}

.dark .html-toolbar {
  background: var(--bg-dark);
}

.html-toolbar.show {
  display: flex;
}

.toolbar-btn {
  padding: 8px 12px;
  background: var(--card-light);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  transition: all 0.3s;
  margin: 0;
}

.dark .toolbar-btn {
  background: var(--card-dark);
  border-color: var(--border-dark);
}

.toolbar-btn:hover {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
  transform: scale(1.05);
}

button {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
  margin: 4px;
  white-space: nowrap;
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
}

button:active {
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--card-light);
  color: var(--text-light);
  border: 2px solid var(--border-light);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.dark .btn-secondary {
  background: var(--card-dark);
  color: var(--text-dark);
  border-color: var(--border-dark);
}

.btn-secondary:hover {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.btn-danger {
  background: linear-gradient(135deg, var(--error), #ff1744);
  box-shadow: 0 4px 15px rgba(255, 59, 109, 0.4);
}

.button-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-top: 15px;
}

.filter-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-tab {
  padding: 10px 20px;
  background: var(--card-light);
  border: 2px solid var(--border-light);
  border-radius: 10px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  transition: all 0.3s;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.dark .filter-tab {
  background: var(--card-dark);
  border-color: var(--border-dark);
}

.filter-tab.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-color: transparent;
}

.filter-tab .count {
  background: rgba(255,255,255,0.3);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 800;
}

.email-output-container {
  background: var(--card-light);
  border: 3px solid var(--primary);
  border-radius: 16px;
  padding: 25px;
  margin-top: 30px;
  max-height: 650px;
  overflow-y: auto;
  box-shadow: 0 6px 30px rgba(0, 212, 255, 0.2);
}

.dark .email-output-container {
  background: var(--card-dark);
  box-shadow: 0 6px 30px rgba(0, 212, 255, 0.3);
}

.email-output-container::-webkit-scrollbar {
  width: 10px;
}

.email-output-container::-webkit-scrollbar-track {
  background: var(--bg-light);
  border-radius: 10px;
}

.dark .email-output-container::-webkit-scrollbar-track {
  background: var(--bg-dark);
}

.email-output-container::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--primary), var(--secondary));
  border-radius: 10px;
}

#output h2 {
  margin-bottom: 20px;
  font-size: 22px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.email-link {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--card-light);
  border: 2px solid var(--border-light);
  border-radius: 10px;
  margin-bottom: 8px;
  transition: all 0.3s;
  text-decoration: none;
  color: var(--text-light);
  border-left: 4px solid var(--border-light);
  min-height: 50px;
  position: relative;
  overflow: hidden;
}

.dark .email-link {
  background: var(--card-dark);
  border-color: var(--border-dark);
  color: var(--text-dark);
}

.email-link:hover {
  transform: translateX(4px);
  border-left-color: var(--primary);
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
}

.email-link.sent {
  background: linear-gradient(90deg, rgba(6, 255, 165, 0.1), rgba(6, 255, 165, 0.05));
  border-left-color: var(--success);
  pointer-events: none;
  opacity: 0.7;
}

.dark .email-link.sent {
  background: linear-gradient(90deg, rgba(6, 255, 165, 0.15), rgba(6, 255, 165, 0.08);
}

.email-link::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(0, 212, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.email-link:active::before {
  width: 300px;
  height: 300px;
}

.email-number {
  min-width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--border-light), var(--bg-light));
  color: var(--text-light);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 12px;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.dark .email-number {
  background: linear-gradient(135deg, var(--border-dark), var(--bg-dark));
  color: var(--text-dark);
}

.email-link.sent .email-number {
  background: linear-gradient(135deg, var(--success), #00cc88);
  color: #0a0e27;
  box-shadow: 0 3px 12px rgba(6, 255, 165, 0.4);
}

.email-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
}

.email-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 13px;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.email-details {
  flex: 1;
  min-width: 0;
}

.email-name {
  font-weight: 700;
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.email-address {
  font-size: 11px;
  opacity: 0.7;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.email-action {
  padding: 6px 12px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.scroll-btn {
  position: fixed;
  right: 20px;
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  font-size: 26px;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
  z-index: 1000;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0;
  padding: 0;
}

.scroll-btn:hover {
  transform: scale(1.15);
  box-shadow: 0 8px 30px rgba(0, 212, 255, 0.7);
}

.scroll-top {
  bottom: 95px;
}

.scroll-bottom {
  bottom: 30px;
}

.toast {
  position: fixed;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%) translateY(120px);
  background: var(--card-light);
  color: var(--text-light);
  padding: 16px 28px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  opacity: 0;
  transition: all 0.4s;
  z-index: 2000;
  border-left: 5px solid var(--primary);
  max-width: 90%;
  text-align: center;
  font-weight: 600;
}

.dark .toast {
  background: var(--card-dark);
  color: var(--text-dark);
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.html-preview {
  background: var(--bg-light);
  border: 2px solid var(--border-light);
  border-radius: 10px;
  padding: 20px;
  margin-top: 15px;
  min-height: 200px;
  max-height: 400px;
  overflow-y: auto;
}

.dark .html-preview {
  background: var(--bg-dark);
  border-color: var(--border-dark);
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border-light);
  border-radius: 10px;
  overflow: hidden;
  margin: 20px 0;
}

.dark .progress-bar {
  background: var(--border-dark);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  width: 0%;
  transition: width 0.3s;
  box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
}

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 3px solid var(--border-light);
  overflow-x: auto;
}

.dark .tabs {
  border-color: var(--border-dark);
}

.tab {
  padding: 12px 22px;
  background: none;
  border: none;
  border-radius: 0;
  box-shadow: none;
  opacity: 0.6;
  font-weight: 700;
  margin: 0;
  border-bottom: 4px solid transparent;
  font-size: 14px;
  white-space: nowrap;
  transition: all 0.3s;
}

.tab:hover {
  opacity: 1;
  transform: translateY(-2px);
}

.tab.active {
  opacity: 1;
  border-bottom-color: var(--primary);
  color: var(--primary);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.preview-card {
  background: var(--bg-light);
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  margin-top: 15px;
}

.dark .preview-card {
  background: var(--bg-dark);
  border-color: var(--border-dark);
}

.preview-header {
  border-bottom: 2px solid var(--border-light);
  padding-bottom: 15px;
  margin-bottom: 15px;
}

.dark .preview-header {
  border-color: var(--border-dark);
}

.preview-label {
  font-size: 11px;
  text-transform: uppercase;
  opacity: 0.6;
  margin-bottom: 6px;
  font-weight: 700;
  letter-spacing: 1px;
}

.preview-value {
  font-size: 16px;
  font-weight: 700;
}

.preview-body {
  white-space: pre-wrap;
  line-height: 1.8;
  font-size: 14px;
}

.score-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 18px;
  border-radius: 25px;
  font-size: 13px;
  font-weight: 700;
  margin-top: 12px;
}

.score-good {
  background: rgba(6, 255, 165, 0.2);
  color: var(--success);
}

.score-warning {
  background: rgba(255, 149, 0, 0.2);
  color: var(--warning);
}

.score-bad {
  background: rgba(255, 59, 109, 0.2);
  color: var(--error);
}

/* Recovery Modal Styles */
.recovery-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card-light);
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  z-index: 3000;
  max-width: 500px;
  width: 90%;
  border: 3px solid var(--primary);
}

.dark .recovery-modal {
  background: var(--card-dark);
}

.recovery-modal h3 {
  margin-bottom: 15px;
  color: var(--primary);
}

.recovery-modal p {
  margin-bottom: 20px;
  opacity: 0.8;
}

.recovery-modal button {
  margin: 5px;
  width: calc(100% - 10px);
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 2999;
  backdrop-filter: blur(5px);
}

.status-indicator {
  position: fixed;
  bottom: 10px;
  right: 10px;
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  z-index: 1000;
  box-shadow: 0 3px 15px rgba(0,0,0,0.2);
}

.status-online {
  background: var(--success);
  color: white;
}

.status-offline {
  background: var(--warning);
  color: white;
}

.status-saving {
  background: var(--primary);
  color: white;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.auto-save-status {
  font-size: 11px;
  opacity: 0.6;
  text-align: right;
  margin-top: 5px;
  font-style: italic;
}

.backup-notice {
  position: fixed;
  top: 70px;
  right: 20px;
  padding: 10px 15px;
  background: var(--warning);
  color: white;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  display: none;
}

.backup-notice.show {
  display: block;
}

footer {
  text-align: center;
  padding: 40px 15px;
  margin-top: 50px;
  opacity: 0.7;
  font-size: 13px;
  font-weight: 500;
}

@media (max-width: 640px) {
  .header-content {
    justify-content: center;
  }
  
  .logo-text {
    font-size: 22px;
  }
  
  .tagline {
    font-size: 11px;
  }
  
  .dashboard {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stat-value {
    font-size: 26px;
  }
  
  .button-grid {
    grid-template-columns: 1fr;
  }
  
  .scroll-btn {
    width: 50px;
    height: 50px;
    right: 15px;
  }
  
  .scroll-top {
    bottom: 85px;
  }
  
  .recovery-modal {
    width: 95%;
    padding: 20px;
  }
}
</style>
</head>
<body class="light">

<div class="top-notification" id="topNotification">
  ‚ö†Ô∏è Email already sent! Cannot send again.
</div>

<div class="status-indicator" id="statusIndicator">üåê Online</div>
<div class="backup-notice" id="backupNotice">üîÑ Creating backup...</div>

<header>
  <div class="header-content">
    <div class="logo-section">
      <div class="logo">F</div>
      <div>
        <div class="logo-text">FATISCO</div>
        <div class="tagline">Premium Email Automation</div>
      </div>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
      <button class="btn-secondary" onclick="showRecoveryOptions()" style="font-size: 12px; padding: 8px 12px;">üîÑ Recovery</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="dashboard">
    <div class="stat-card">
      <div class="stat-label">TOTAL</div>
      <div class="stat-value" id="totalEmails">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">VALID</div>
      <div class="stat-value" id="validEmails">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">SENT</div>
      <div class="stat-value" id="emailsSent">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">SPAM</div>
      <div class="stat-value" id="spamScore">-</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">
      <span class="card-icon">üìß</span>
      Email List
    </div>
    
    <div class="file-upload">
      <input type="file" id="fileInput" accept=".csv,.txt">
      <label for="fileInput" class="file-upload-label">
        <span>üìÅ</span>
        <span>Upload CSV/TXT File</span>
      </label>
    </div>
    
    <label>Paste Emails (email,name,company)</label>
    <textarea id="list" rows="6" placeholder="john@acme.com,John Doe,Acme Corp
jane@startup.io,Jane Smith,Startup Inc
bob@tech.ng,Bob Johnson,Tech Nigeria"></textarea>
    
    <div class="button-grid">
      <button class="btn-secondary" onclick="cleanList()">üßπ Clean List</button>
      <button class="btn-secondary" onclick="saveTemplate()">üíæ Save Template</button>
      <button class="btn-secondary" onclick="forceSave()">üíæ Force Save</button>
      <button class="btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All</button>
    </div>
    <div class="auto-save-status">Auto-save: <span id="saveStatus">Ready</span></div>
  </div>

  <div class="card">
    <div class="card-title">
      <span class="card-icon">‚úâÔ∏è</span>
      Email Composer
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab(event, 'compose')">Compose</button>
      <button class="tab" onclick="switchTab(event, 'preview')">Preview</button>
      <button class="tab" onclick="switchTab(event, 'html-preview')">HTML Preview</button>
      <button class="tab" onclick="switchTab(event, 'test')">A/B Test</button>
    </div>

    <div class="tab-content active" id="compose-tab">
      <label>Template</label>
      <select id="template" onchange="loadTemplate()">
        <option value="0">Default Professional</option>
        <option value="1">Business Pitch</option>
        <option value="2">Freelance Offer</option>
        <option value="3">Product Intro</option>
        <option value="4">Networking</option>
      </select>

      <label>Subject Line</label>
      <input id="subject" value="Opportunity for {company}">

      <label>Email Options</label>
      <div class="button-grid" style="margin-bottom: 15px;">
        <button class="btn-secondary" id="ccToggle" onclick="toggleCC()">üìß Add CC</button>
        <button class="btn-secondary" id="bccToggle" onclick="toggleBCC()">üì® Add BCC</button>
      </div>

      <div id="ccField" style="display: none; margin-bottom: 15px;">
        <label>CC Email (same for all)</label>
        <input id="ccEmail" type="email" placeholder="cc@example.com">
      </div>

      <div id="bccField" style="display: none; margin-bottom: 15px;">
        <label>BCC Email (same for all)</label>
        <input id="bccEmail" type="email" placeholder="bcc@example.com">
      </div>

      <label>Email Format</label>
      <div class="format-selector">
        <button class="format-btn active" onclick="setFormat('plain')">üìù Plain Text</button>
        <button class="format-btn" onclick="setFormat('html')">üé® HTML</button>
      </div>

      <div id="htmlToolbar" class="html-toolbar">
        <button class="toolbar-btn" onclick="insertHTML('bold')"><b>B</b></button>
        <button class="toolbar-btn" onclick="insertHTML('italic')"><i>I</i></button>
        <button class="toolbar-btn" onclick="insertHTML('underline')"><u>U</u></button>
        <button class="toolbar-btn" onclick="insertHTML('h1')">H1</button>
        <button class="toolbar-btn" onclick="insertHTML('h2')">H2</button>
        <button class="toolbar-btn" onclick="insertHTML('link')">üîó Link</button>
        <button class="toolbar-btn" onclick="insertHTML('ul')">‚Ä¢ List</button>
        <button class="toolbar-btn" onclick="insertHTML('color')">üé® Color</button>
        <button class="toolbar-btn" onclick="copyHTML()">üìã Copy HTML</button>
      </div>

      <label>Message Body</label>
      <textarea id="body" rows="8">Hi {name},

I noticed {company} is doing great work. I'd love to discuss collaboration opportunities.

Looking forward to connecting!</textarea>

      <div id="htmlCodeEditor" style="display: none;">
        <label>HTML Code (Advanced)</label>
        <textarea id="htmlCode" rows="8" placeholder="<p>Your HTML code here...</p>"></textarea>
      </div>
    </div>

    <div class="tab-content" id="preview-tab">
      <div class="preview-card">
        <div class="preview-header">
          <div class="preview-label">SUBJECT</div>
          <div class="preview-value" id="previewSubject">-</div>
        </div>
        <div class="preview-body" id="previewBody">Add emails to preview</div>
        <div class="score-badge score-good" id="spamScoreBadge">
          ‚úì Low Spam Risk
        </div>
      </div>
    </div>

    <div class="tab-content" id="html-preview-tab">
      <div class="preview-card">
        <div class="preview-header">
          <div class="preview-label">HTML RENDERED PREVIEW</div>
          <div class="preview-label" style="margin-top: 10px; opacity: 0.8;">Note: Gmail doesn't support HTML in mailto: links. Use "Copy HTML" button to paste into Gmail compose.</div>
        </div>
        <div class="html-preview" id="htmlPreview">
          <p style="color: #666;">Add content and switch to HTML format to see preview...</p>
        </div>
      </div>
    </div>

    <div class="tab-content" id="test-tab">
      <label>Subject Line A</label>
      <input id="subjectA" placeholder="First variant">
      
      <label>Subject Line B</label>
      <input id="subjectB" placeholder="Second variant">
      
      <button onclick="compareSubjects()">‚ö° Compare Performance</button>
      <div id="abResults"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">
      <span class="card-icon">üöÄ</span>
      Actions
    </div>
    
    <div class="button-grid">
      <button onclick="generateLinks()">‚ö° Generate Links</button>
      <button class="btn-secondary" onclick="downloadCSV()">üì• Download CSV</button>
      <button class="btn-secondary" onclick="analyzeSpam()">üîç Spam Check</button>
      <button class="btn-secondary" onclick="scheduleEmails()">üìÖ Schedule</button>
      <button class="btn-secondary" onclick="createBackup()">üíæ Create Backup</button>
    </div>

    <div class="progress-bar" id="progressBar" style="display: none;">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <div class="email-output-container" id="outputContainer" style="display: none;">
    <div class="filter-tabs">
      <button class="filter-tab active" onclick="filterEmails('all')">
        üìß All <span class="count" id="countAll">0</span>
      </button>
      <button class="filter-tab" onclick="filterEmails('pending')">
        ‚è≥ Pending <span class="count" id="countPending">0</span>
      </button>
      <button class="filter-tab" onclick="filterEmails('sent')">
        ‚úÖ Sent <span class="count" id="countSent">0</span>
      </button>
    </div>
    <div id="output"></div>
  </div>
</div>

<button class="scroll-btn scroll-top" onclick="scrollToTop()" style="display: none;">‚Üë</button>
<button class="scroll-btn scroll-bottom" onclick="scrollToBottom()" style="display: none;">‚Üì</button>

<footer>
  Built by Fatai | FATISCO ¬© 2026 | Premium Email Automation
</footer>

<div class="toast" id="toast"></div>

<script>
// Enhanced storage system
const templates = [
  {
    subj: "Opportunity for {company}",
    body: "Hi {name},\n\nI noticed {company} is doing great work. I'd love to discuss collaboration opportunities.\n\nLooking forward to connecting!"
  },
  {
    subj: "Business Collaboration with {company}",
    body: "Dear {name},\n\nI've been following {company}'s progress. Let's explore partnership opportunities.\n\nBest regards,"
  },
  {
    subj: "Freelance Services for {company}",
    body: "Hello {name},\n\nI specialize in helping companies like {company} achieve their goals. Interested?\n\nCheers,"
  },
  {
    subj: "Introducing Our Product to {company}",
    body: "Hi {name},\n\nOur solution has helped companies like {company} boost efficiency by 40%.\n\nThanks,"
  },
  {
    subj: "Let's Connect, {name}",
    body: "Hello {name},\n\nI admire what {company} is doing. Let's explore synergies.\n\nBest,"
  }
];

let stats = {total: 0, valid: 0};
let sentEmails = {};
let emailFormat = 'plain';
let ccEnabled = false;
let bccEnabled = false;
let currentFilter = 'all';
let saveQueue = [];
let isSaving = false;
let db = null;
let lastSaveTime = 0;
let unsavedChanges = false;

// Initialize storage systems
async function initStorageSystems() {
  console.log('üöÄ Initializing storage systems...');
  
  // Try IndexedDB
  try {
    await initIndexedDB();
    console.log('‚úÖ IndexedDB initialized');
  } catch (e) {
    console.warn('‚ùå IndexedDB failed:', e);
  }
  
  // Register Service Worker
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigatorServiceWorker.register('/sw.js');
      console.log('‚úÖ Service Worker registered');
      
      // Check for updates
      registration.addEventListener('updatefound', () => {
        console.log('üîÑ New Service Worker found');
      });
    } catch (error) {
      console.warn('‚ùå Service Worker registration failed:', error);
    }
  }
  
  // Check initial online status
  updateOnlineStatus();
  
  // Load all data from available sources
  await loadAllData();
  
  // Start auto-save system
  startAutoSave();
}

// Initialize IndexedDB
async function initIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('FatiscoDB', 2);
    
    request.onerror = (event) => {
      console.error('IndexedDB error:', event.target.error);
      reject(event.target.error);
    };
    
    request.onsuccess = (event) => {
      db = event.target.result;
      
      // Handle database version changes
      db.onversionchange = () => {
        db.close();
        console.log('Database is outdated, please reload the page.');
      };
      
      console.log('‚úÖ IndexedDB connected');
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      
      // Create object stores if they don't exist
      if (!db.objectStoreNames.contains('saves')) {
        const saveStore = db.createObjectStore('saves', { keyPath: 'id' });
        saveStore.createIndex('timestamp', 'timestamp', { unique: false });
      }
      
      if (!db.objectStoreNames.contains('emails')) {
        const emailStore = db.createObjectStore('emails', { keyPath: 'email' });
        emailStore.createIndex('timestamp', 'timestamp', { unique: false });
      }
      
      if (!db.objectStoreNames.contains('backups')) {
        const backupStore = db.createObjectStore('backups', { keyPath: 'id', autoIncrement: true });
        backupStore.createIndex('timestamp', 'timestamp', { unique: false });
      }
      
      console.log('üîÑ IndexedDB schema upgraded to version', event.newVersion);
    };
    
    request.onblocked = () => {
      console.warn('IndexedDB blocked - please close other tabs');
    };
  });
}

// Save to IndexedDB
async function saveToIndexedDB(data) {
  if (!db) return;
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['saves', 'emails'], 'readwrite');
    
    // Save main data
    const saveData = {
      id: 'current',
      ...data,
      timestamp: Date.now(),
      savedAt: new Date().toISOString()
    };
    
    transaction.objectStore('saves').put(saveData);
    
    // Save individual emails
    const lines = data.emailList.split('\n');
    const emailStore = transaction.objectStore('emails');
    
    lines.forEach(line => {
      const parsed = parseLine(line);
      if (parsed) {
        parsed.timestamp = Date.now();
        emailStore.put(parsed);
      }
    });
    
    transaction.oncomplete = () => {
      console.log('üíæ Saved to IndexedDB');
      resolve();
    };
    
    transaction.onerror = (event) => {
      console.error('IndexedDB save error:', event.target.error);
      reject(event.target.error);
    };
  });
}

// Load from IndexedDB
async function loadFromIndexedDB() {
  if (!db) return null;
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['saves'], 'readonly');
    const store = transaction.objectStore('saves');
    const request = store.get('current');
    
    request.onsuccess = (event) => {
      resolve(event.target.result);
    };
    
    request.onerror = (event) => {
      reject(event.target.error);
    };
  });
}

// Enhanced save function with multiple fallbacks
async function saveDataRobust() {
  if (isSaving) {
    // Queue the save request
    unsavedChanges = true;
    return;
  }
  
  isSaving = true;
  updateSaveStatus('Saving...');
  
  const data = {
    emailList: document.getElementById('list').value,
    subject: document.getElementById('subject').value,
    body: document.getElementById('body').value,
    emailFormat: emailFormat,
    ccEnabled: ccEnabled,
    ccEmail: document.getElementById('ccEmail').value,
    bccEnabled: bccEnabled,
    bccEmail: document.getElementById('bccEmail').value,
    sentEmails: sentEmails,
    timestamp: Date.now()
  };
  
  let saveSuccessful = false;
  const saveAttempts = [];
  
  try {
    // 1. Try localStorage (primary)
    try {
      localStorage.setItem('fatisco_data_v2', JSON.stringify(data));
      saveAttempts.push('localStorage');
      
      // Create backup copy
      localStorage.setItem(`fatisco_backup_${Date.now()}`, JSON.stringify(data));
      
      // Clean old backups (keep last 10)
      const backupKeys = Object.keys(localStorage)
        .filter(k => k.startsWith('fatisco_backup_'))
        .sort()
        .reverse()
        .slice(10);
      
      backupKeys.forEach(k => localStorage.removeItem(k));
    } catch (lsError) {
      console.warn('localStorage failed:', lsError);
    }
    
    // 2. Try IndexedDB (secondary)
    try {
      if (db) {
        await saveToIndexedDB(data);
        saveAttempts.push('IndexedDB');
      }
    } catch (idbError) {
      console.warn('IndexedDB failed:', idbError);
    }
    
    // 3. Try sessionStorage (tertiary)
    try {
      const minimalData = {
        l: data.emailList.substring(0, 50000), // Limit size
        se: data.sentEmails,
        t: data.timestamp
      };
      sessionStorage.setItem('fatisco_emergency', JSON.stringify(minimalData));
      saveAttempts.push('sessionStorage');
    } catch (ssError) {
      console.warn('sessionStorage failed:', ssError);
    }
    
    // 4. Try in-memory cache (last resort)
    try {
      window.fatiscoCache = data;
      saveAttempts.push('memoryCache');
    } catch (cacheError) {
      console.warn('Memory cache failed:', cacheError);
    }
    
    saveSuccessful = saveAttempts.length > 0;
    lastSaveTime = Date.now();
    unsavedChanges = false;
    
    if (saveSuccessful) {
      console.log(`‚úÖ Saved to: ${saveAttempts.join(', ')}`);
      updateSaveStatus(`Saved to ${saveAttempts.length} locations`);
      
      // Show brief success indicator
      if (saveAttempts.length >= 2) {
        showToast(`üíæ Saved to ${saveAttempts.length} locations`);
      }
    } else {
      console.error('‚ùå All save methods failed');
      updateSaveStatus('Save failed!');
    }
    
  } catch (error) {
    console.error('üí• Critical save error:', error);
    updateSaveStatus('Error!');
    
    // Emergency minimal save
    try {
      localStorage.setItem('fatisco_minimal', JSON.stringify({
        l: data.emailList.substring(0, 1000),
        se: data.sentEmails,
        e: 'emergency',
        t: Date.now()
      }));
      console.log('üÜò Emergency save completed');
    } catch (e) {
      console.error('üí• Even emergency save failed!');
    }
  } finally {
    isSaving = false;
    updateStatusIndicator();
    
    // Process any queued saves
    if (unsavedChanges) {
      setTimeout(saveDataRobust, 100);
    }
  }
}

// Load from all available sources
async function loadAllData() {
  console.log('üìÇ Loading data from all sources...');
  
  let loadedData = null;
  const loadSources = [];
  
  // 1. Try localStorage v2
  try {
    const saved = localStorage.getItem('fatisco_data_v2');
    if (saved) {
      loadedData = JSON.parse(saved);
      loadSources.push('localStorage v2');
    }
  } catch (e) {
    console.warn('localStorage v2 load failed:', e);
  }
  
  // 2. Try localStorage v1 (legacy)
  if (!loadedData) {
    try {
      const saved = localStorage.getItem('fatisco_data');
      if (saved) {
        loadedData = JSON.parse(saved);
        loadSources.push('localStorage v1');
      }
    } catch (e) {
      console.warn('localStorage v1 load failed:', e);
    }
  }
  
  // 3. Try IndexedDB
  if (!loadedData) {
    try {
      loadedData = await loadFromIndexedDB();
      if (loadedData) loadSources.push('IndexedDB');
    } catch (e) {
      console.warn('IndexedDB load failed:', e);
    }
  }
  
  // 4. Try sessionStorage backup
  if (!loadedData) {
    try {
      const backup = sessionStorage.getItem('fatisco_emergency');
      if (backup) {
        const emergencyData = JSON.parse(backup);
        loadedData = {
          emailList: emergencyData.l || '',
          sentEmails: emergencyData.se || {},
          timestamp: emergencyData.t
        };
        loadSources.push('sessionStorage backup');
      }
    } catch (e) {
      console.warn('sessionStorage load failed:', e);
    }
  }
  
  // 5. Try in-memory cache
  if (!loadedData && window.fatiscoCache) {
    loadedData = window.fatiscoCache;
    loadSources.push('memory cache');
  }
  
  // 6. Try backup files (most recent)
  if (!loadedData) {
    try {
      const backupKeys = Object.keys(localStorage)
        .filter(k => k.startsWith('fatisco_backup_'))
        .sort()
        .reverse();
      
      for (const key of backupKeys) {
        try {
          const backup = localStorage.getItem(key);
          if (backup) {
            loadedData = JSON.parse(backup);
            loadSources.push(`backup: ${key}`);
            break;
          }
        } catch (e) {
          console.warn(`Backup ${key} corrupted`);
        }
      }
    } catch (e) {
      console.warn('Backup recovery failed:', e);
    }
  }
  
  if (loadedData) {
    applyLoadedData(loadedData);
    const sentCount = Object.keys(loadedData.sentEmails || {}).length;
    showToast(`üìÇ Loaded from ${loadSources[0]} (${sentCount} sent emails)`);
    console.log(`‚úÖ Loaded from: ${loadSources.join(', ')}`);
  } else {
    console.log('üÜï No saved data found, starting fresh');
  }
  
  updateStats();
}

// Apply loaded data to UI
function applyLoadedData(data) {
  if (data.emailList !== undefined) {
    document.getElementById('list').value = data.emailList;
  }
  
  if (data.subject !== undefined) {
    document.getElementById('subject').value = data.subject;
  }
  
  if (data.body !== undefined) {
    document.getElementById('body').value = data.body;
  }
  
  if (data.emailFormat !== undefined) {
    emailFormat = data.emailFormat;
    setFormat(emailFormat);
  }
  
  if (data.ccEnabled !== undefined) {
    ccEnabled = data.ccEnabled;
    if (ccEnabled) toggleCC();
    if (data.ccEmail) document.getElementById('ccEmail').value = data.ccEmail;
  }
  
  if (data.bccEnabled !== undefined) {
    bccEnabled = data.bccEnabled;
    if (bccEnabled) toggleBCC();
    if (data.bccEmail) document.getElementById('bccEmail').value = data.bccEmail;
  }
  
  if (data.sentEmails !== undefined) {
    sentEmails = data.sentEmails;
  }
  
  // Update stats based on loaded data
  const lines = document.getElementById('list').value.trim().split('\n').filter(l => l.trim());
  stats.total = lines.length;
  stats.valid = lines.filter(l => l.includes('@')).length;
}

// Force save (manual)
function forceSave() {
  showToast('üíæ Force saving...');
  saveDataRobust();
}

// Create backup
async function createBackup() {
  const backupNotice = document.getElementById('backupNotice');
  backupNotice.classList.add('show');
  backupNotice.textContent = 'üîÑ Creating backup...';
  
  try {
    const data = {
      emailList: document.getElementById('list').value,
      subject: document.getElementById('subject').value,
      body: document.getElementById('body').value,
      emailFormat: emailFormat,
      sentEmails: sentEmails,
      timestamp: Date.now(),
      backup: true
    };
    
    // Save to IndexedDB backups
    if (db) {
      const transaction = db.transaction(['backups'], 'readwrite');
      const store = transaction.objectStore('backups');
      
      await new Promise((resolve, reject) => {
        const request = store.add(data);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // Also save to localStorage
    localStorage.setItem(`fatisco_manual_backup_${Date.now()}`, JSON.stringify(data));
    
    backupNotice.textContent = '‚úÖ Backup created!';
    showToast('üíæ Manual backup created successfully');
  } catch (error) {
    backupNotice.textContent = '‚ùå Backup failed';
    console.error('Backup failed:', error);
    showToast('‚ö†Ô∏è Backup failed');
  }
  
  setTimeout(() => {
    backupNotice.classList.remove('show');
  }, 3000);
}

// Update save status display
function updateSaveStatus(status) {
  const statusEl = document.getElementById('saveStatus');
  if (statusEl) {
    statusEl.textContent = status;
    statusEl.style.color = status.includes('Error') ? 'var(--error)' : 
                          status.includes('Saved') ? 'var(--success)' : 
                          'inherit';
  }
}

// Update online/offline status
function updateOnlineStatus() {
  const isOnline = navigator.onLine;
  const indicator = document.getElementById('statusIndicator');
  
  if (isOnline) {
    indicator.textContent = 'üåê Online';
    indicator.className = 'status-indicator status-online';
  } else {
    indicator.textContent = 'üì¥ Offline';
    indicator.className = 'status-indicator status-offline';
    showToast('üì¥ Working offline - changes saved locally');
  }
}

function updateStatusIndicator() {
  const indicator = document.getElementById('statusIndicator');
  if (isSaving) {
    indicator.textContent = 'üíæ Saving...';
    indicator.className = 'status-indicator status-saving';
  } else {
    updateOnlineStatus();
  }
}

// Enhanced auto-save system
function startAutoSave() {
  // Debounced save on input
  let saveTimeout;
  
  function scheduleSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      if (!isSaving) {
        saveDataRobust();
      }
    }, 1000); // 1 second debounce
  }
  
  // Monitor inputs for changes
  const inputsToWatch = ['list', 'subject', 'body', 'ccEmail', 'bccEmail', 'htmlCode'];
  inputsToWatch.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('input', scheduleSave);
    }
  });
  
  // Periodic save every 30 seconds
  setInterval(() => {
    if (document.getElementById('list').value.trim() && !isSaving) {
      saveDataRobust();
    }
  }, 30000);
  
  // Save on visibility change
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && !isSaving) {
      saveDataRobust();
    }
  });
  
  console.log('‚úÖ Auto-save system started');
}

// Show recovery options
function showRecoveryOptions() {
  const modalHTML = `
    <div class="modal-overlay" onclick="closeRecoveryModal()"></div>
    <div class="recovery-modal">
      <h3>üîÑ Data Recovery Options</h3>
      <p>Choose where to recover data from:</p>
      <button onclick="recoverFrom('localStorage')">üìÅ localStorage (Current)</button>
      <button onclick="recoverFrom('indexeddb')">üíæ IndexedDB</button>
      <button onclick="recoverFrom('backup')">üïê Latest Backup</button>
      <button onclick="recoverFrom('session')">‚ö° Session Backup</button>
      <button onclick="showBackupList()">üìã View All Backups</button>
      <button class="btn-secondary" onclick="closeRecoveryModal()" style="margin-top: 15px;">Cancel</button>
    </div>
  `;
  
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  modalContainer.id = 'recoveryModalContainer';
  document.body.appendChild(modalContainer);
}

function closeRecoveryModal() {
  const modal = document.getElementById('recoveryModalContainer');
  if (modal) modal.remove();
}

async function recoverFrom(source) {
  closeRecoveryModal();
  
  showToast(`üîÑ Recovering from ${source}...`);
  
  switch(source) {
    case 'localStorage':
      try {
        const saved = localStorage.getItem('fatisco_data_v2') || localStorage.getItem('fatisco_data');
        if (saved) {
          const data = JSON.parse(saved);
          applyLoadedData(data);
          showToast('‚úÖ Recovered from localStorage');
        }
      } catch (e) {
        showToast('‚ùå Recovery failed');
      }
      break;
      
    case 'indexeddb':
      try {
        const data = await loadFromIndexedDB();
        if (data) {
          applyLoadedData(data);
          showToast('‚úÖ Recovered from IndexedDB');
        }
      } catch (e) {
        showToast('‚ùå IndexedDB recovery failed');
      }
      break;
      
    case 'backup':
      try {
        const backupKeys = Object.keys(localStorage)
          .filter(k => k.startsWith('fatisco_backup_') || k.startsWith('fatisco_manual_backup_'))
          .sort()
          .reverse();
        
        if (backupKeys.length > 0) {
          const backup = localStorage.getItem(backupKeys[0]);
          if (backup) {
            const data = JSON.parse(backup);
            applyLoadedData(data);
            showToast(`‚úÖ Recovered from backup (${backupKeys[0]})`);
          }
        }
      } catch (e) {
        showToast('‚ùå Backup recovery failed');
      }
      break;
      
    case 'session':
      try {
        const backup = sessionStorage.getItem('fatisco_emergency');
        if (backup) {
          const data = JSON.parse(backup);
          // Convert emergency format
          const fullData = {
            emailList: data.l || '',
            sentEmails: data.se || {}
          };
          applyLoadedData(fullData);
          showToast('‚úÖ Recovered from session backup');
        }
      } catch (e) {
        showToast('‚ùå Session recovery failed');
      }
      break;
  }
}

// Rest of your existing functions (with minor adjustments)
function toggleTheme() {
  document.body.classList.toggle('dark');
  document.body.classList.toggle('light');
  const isDark = document.body.classList.contains('dark');
  try {
    localStorage.setItem('fatisco_theme', isDark ? 'dark' : 'light');
  } catch(e) {}
  
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
}

function loadSavedTheme() {
  try {
    const saved = localStorage.getItem('fatisco_theme');
    if (saved === 'dark') {
      document.body.classList.remove('light');
      document.body.classList.add('dark');
      document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è Light Mode';
    }
  } catch(e) {}
}

function showToast(message, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

function showTopNotification(message) {
  const notif = document.getElementById('topNotification');
  if (message) notif.textContent = message;
  notif.classList.add('show');
  setTimeout(() => notif.classList.remove('show'), 3000);
}

function updateStats() {
  document.getElementById('totalEmails').textContent = stats.total;
  document.getElementById('validEmails').textContent = stats.valid;
  document.getElementById('emailsSent').textContent = Object.keys(sentEmails).length;
}

function parseLine(line) {
  const parts = line.split(',').map(p => p.trim());
  const email = parts[0];
  if (!email || !email.includes('@')) return null;
  
  let name = parts[1] || email.split('@')[0].split(/[\._-]/).map(p =>
    p.charAt(0).toUpperCase() + p.slice(1)
  ).join(' ');
  
  let company = parts[2] || (email.split('@')[1] ? email.split('@')[1].split('.')[0] : 'your company');
  company = company.charAt(0).toUpperCase() + company.slice(1);
  
  return {
    email: email,
    name: name.trim() || 'there',
    company: company,
    custom1: parts[3] || '',
    custom2: parts[4] || ''
  };
}

function toggleCC() {
  ccEnabled = !ccEnabled;
  const field = document.getElementById('ccField');
  const btn = document.getElementById('ccToggle');
  
  if (ccEnabled) {
    field.style.display = 'block';
    btn.style.background = 'linear-gradient(135deg, var(--success), #00cc88)';
  } else {
    field.style.display = 'none';
    btn.style.background = '';
  }
  saveDataRobust();
}

function toggleBCC() {
  bccEnabled = !bccEnabled;
  const field = document.getElementById('bccField');
  const btn = document.getElementById('bccToggle');
  
  if (bccEnabled) {
    field.style.display = 'block';
    btn.style.background = 'linear-gradient(135deg, var(--success), #00cc88)';
  } else {
    field.style.display = 'none';
    btn.style.background = '';
  }
  saveDataRobust();
}

function setFormat(format) {
  emailFormat = format;
  const buttons = document.querySelectorAll('.format-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  if (format === 'html') {
    buttons[1].classList.add('active');
    document.getElementById('htmlToolbar').classList.add('show');
    document.getElementById('htmlCodeEditor').style.display = 'block';
    updateHTMLPreview();
  } else {
    buttons[0].classList.add('active');
    document.getElementById('htmlToolbar').classList.remove('show');
    document.getElementById('htmlCodeEditor').style.display = 'none';
  }
  
  saveDataRobust();
  showToast(format === 'html' ? 'üé® HTML Mode Enabled' : 'üìù Plain Text Mode');
}

// ... (rest of your existing functions remain mostly the same, just replace saveData() with saveDataRobust())

// Event listeners
window.addEventListener('load', async () => {
  loadSavedTheme();
  await initStorageSystems();
  console.log('üöÄ FATISCO fully loaded with enhanced offline support!');
});

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Enhanced beforeunload handler
window.addEventListener('beforeunload', (event) => {
  if (unsavedChanges || isSaving) {
    event.preventDefault();
    event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    
    // Try one final save
    if (!isSaving) {
      saveDataRobust();
    }
  }
});

// File input handler
document.getElementById('fileInput').addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    const lines = content.split(/\r?\n/).filter(l => l.trim());
    document.getElementById('list').value = lines.join('\n');
    showToast('üìÅ File loaded: ' + lines.length + ' lines');
    cleanList();
    saveDataRobust();
  };
  reader.readAsText(file);
});

// Input listeners for auto-save
document.getElementById('list').addEventListener('input', function() {
  const lines = this.value.trim().split('\n').filter(l => l.trim());
  stats.total = lines.length;
  stats.valid = lines.filter(l => l.includes('@')).length;
  updateStats();
});

// Initialize
initStorageSystems();
</script>

<script>
// Inline Service Worker registration (for single-file deployment)
if ('serviceWorker' in navigator) {
  const swScript = `
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open('fatisco-v2').then(cache => {
      return cache.addAll([
        './',
        './index.html'
      ]);
    })
  );
  self.skipWaiting();
});

self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.filter(name => name.startsWith('fatisco-') && name !== 'fatisco-v2')
          .map(name => caches.delete(name))
      );
    })
  );
  self.clients.claim();
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(response => {
      return response || fetch(event.request);
    })
  );
});

self.addEventListener('sync', event => {
  if (event.tag === 'save-data') {
    console.log('Background sync: save-data');
  }
});
`;

  // Create and register service worker
  const blob = new Blob([swScript], { type: 'application/javascript' });
  const swURL = URL.createObjectURL(blob);
  
  navigator.serviceWorker.register(swURL).then(registration => {
    console.log('‚úÖ Service Worker registered successfully');
  }).catch(error => {
    console.log('‚ùå Service Worker registration failed:', error);
  });
}
</script>
</body>
</html>
