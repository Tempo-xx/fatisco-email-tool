<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FATISCO | Email Automation</title>
<style>
/* Reset & Base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f5f7fa;
  color: #333;
  line-height: 1.4;
  overflow-x: hidden;
  padding-bottom: 60px;
}

body.dark {
  background: #0f172a;
  color: #e2e8f0;
}

/* Header */
.header {
  background: #4f46e5;
  padding: 12px 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.dark .header {
  background: #1e1b4b;
}

.header-content {
  max-width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
  color: white;
  text-decoration: none;
}

.logo-icon {
  font-size: 20px;
  font-weight: bold;
}

.logo-text {
  font-size: 18px;
  font-weight: 700;
}

.theme-toggle {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
}

/* Main Container */
.container {
  max-width: 100%;
  padding: 16px;
}

/* Stats */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.dark .stat-card {
  background: #1e293b;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.stat-value {
  font-size: 28px;
  font-weight: 800;
  color: #4f46e5;
  line-height: 1;
  margin-bottom: 4px;
}

.dark .stat-value {
  color: #818cf8;
}

.stat-label {
  font-size: 12px;
  color: #666;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dark .stat-label {
  color: #94a3b8;
}

.time-info {
  font-size: 10px;
  color: #666;
  margin-top: 4px;
  font-style: italic;
}

.dark .time-info {
  color: #94a3b8;
}

/* Cards */
.card {
  background: white;
  border-radius: 12px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  overflow: hidden;
}

.dark .card {
  background: #1e293b;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.card-header {
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.dark .card-header {
  border-color: #334155;
}

.card-icon {
  font-size: 18px;
}

.card-title {
  font-size: 16px;
  font-weight: 600;
}

.card-body {
  padding: 16px;
}

/* File Upload */
.file-upload {
  margin-bottom: 16px;
}

.file-input {
  display: none;
}

.file-label {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px;
  background: #f8fafc;
  border: 2px dashed #cbd5e1;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.dark .file-label {
  background: #1e293b;
  border-color: #475569;
  color: #cbd5e1;
}

.file-label:hover {
  border-color: #4f46e5;
}

/* Inputs */
.input-group {
  margin-bottom: 16px;
}

.label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 6px;
  color: #333;
}

.dark .label {
  color: #e2e8f0;
}

.textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  background: white;
  color: #333;
  resize: vertical;
  min-height: 120px;
}

.dark .text-area {
  background: #1e293b;
  border-color: #475569;
  color: #e2e8f0;
}

.textarea:focus {
  outline: none;
  border-color: #4f46e5;
}

.input {
  width: 100%;
  padding: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  font-size: 14px;
  background: white;
  color: #333;
}

.dark .input {
  background: #1e293b;
  border-color: #475569;
  color: #e2e8f0;
}

.input:focus {
  outline: none;
  border-color: #4f46e5;
}

/* Buttons */
.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 16px;
}

.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.btn-primary {
  background: #4f46e5;
  color: white;
}

.btn-primary:hover {
  background: #4338ca;
}

.btn-secondary {
  background: #f1f5f9;
  color: #333;
  border: 1px solid #cbd5e1;
}

.dark .btn-secondary {
  background: #334155;
  color: #e2e8f0;
  border-color: #475569;
}

.btn-secondary:hover {
  background: #e2e8f0;
}

.dark .btn-secondary:hover {
  background: #475569;
}

.btn-danger {
  background: #dc2626;
  color: white;
}

.btn-danger:hover {
  background: #b91c1c;
}

/* Email List Card */
.email-list-container {
  display: none;
  background: white;
  border-radius: 12px;
  margin-top: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.dark .email-list-container {
  background: #1e293b;
}

.email-list-header {
  padding: 12px 16px;
  border-bottom: 1px solid #e2e8f0;
}

.dark .email-list-header {
  border-color: #334155;
}

.email-filters {
  display: flex;
  gap: 8px;
}

.filter-btn {
  padding: 6px 12px;
  background: #f1f5f9;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  color: #333;
  cursor: pointer;
}

.dark .filter-btn {
  background: #334155;
  border-color: #475569;
  color: #e2e8f0;
}

.filter-btn.active {
  background: #4f46e5;
  color: white;
  border-color: #4f46e5;
}

.filter-count {
  background: rgba(255,255,255,0.2);
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 10px;
  margin-left: 4px;
}

/* Email Links - COMPACT */
.email-list {
  max-height: 400px;
  overflow-y: auto;
  padding: 8px;
}

.email-link {
  display: flex;
  align-items: center;
  padding: 8px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 6px;
  text-decoration: none;
  color: inherit;
  font-size: 12px;
  min-height: 44px;
  cursor: pointer;
  transition: all 0.2s;
}

.dark .email-link {
  background: #1e293b;
  border-color: #334155;
}

.email-link:hover {
  border-color: #4f46e5;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.email-link.sent {
  background: #f0fdf4;
  border-color: #bbf7d0;
  opacity: 0.7;
  cursor: default;
}

.dark .email-link.sent {
  background: #064e3b;
  border-color: #047857;
}

.email-number {
  min-width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #4f46e5;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  margin-right: 8px;
  flex-shrink: 0;
  transition: background 0.2s;
}

.email-link.sent .email-number {
  background: #10b981;
}

.email-content {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  min-width: 0;
}

.email-info {
  flex: 1;
  min-width: 0;
}

.email-name {
  font-weight: 600;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.email-address {
  font-size: 11px;
  color: #666;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.dark .email-address {
  color: #94a3b8;
}

.email-action {
  padding: 4px 10px;
  background: #4f46e5;
  color: white;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  pointer-events: auto;
}

.email-action:hover {
  background: #4338ca;
  transform: translateY(-1px);
}

.email-link.sent .email-action {
  background: #10b981;
  cursor: default;
}

.email-link.sent .email-action:hover {
  background: #10b981;
  transform: none;
}

/* Scroll Buttons */
.scroll-btn {
  position: fixed;
  right: 16px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #4f46e5;
  color: white;
  border: none;
  font-size: 18px;
  cursor: pointer;
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

.scroll-btn:hover {
  background: #4338ca;
}

.scroll-top {
  bottom: 80px;
}

.scroll-bottom {
  bottom: 24px;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #1e293b;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s;
  max-width: 90%;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* Footer */
.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px 16px;
  border-top: 1px solid #e2e8f0;
  text-align: center;
  font-size: 12px;
  color: #666;
  z-index: 99;
}

.dark .footer {
  background: #1e293b;
  border-color: #334155;
  color: #94a3b8;
}

/* Media Queries for Mobile Optimization */
@media (max-width: 768px) {
  html {
    font-size: 14px;
  }
  
  .container {
    padding: 12px;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  
  .stat-card {
    padding: 12px;
  }
  
  .stat-value {
    font-size: 24px;
  }
  
  .card {
    margin-bottom: 12px;
  }
  
  .card-header, .card-body {
    padding: 12px;
  }
  
  .button-group {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
  
  .email-link {
    padding: 6px;
    margin-bottom: 4px;
  }
  
  .scroll-btn {
    width: 40px;
    height: 40px;
    right: 12px;
  }
  
  .scroll-top {
    bottom: 76px;
  }
  
  .scroll-bottom {
    bottom: 24px;
  }
}

@media (max-width: 480px) {
  .header {
    padding: 10px 12px;
  }
  
  .container {
    padding: 10px;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stat-value {
    font-size: 22px;
  }
  
  .email-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  
  .email-action {
    align-self: flex-end;
  }
}

/* Prevent horizontal scroll */
body, .container, .card, .email-list-container {
  max-width: 100vw;
  overflow-x: hidden;
}
</style>
</head>
<body class="light">

<div class="header">
  <div class="header-content">
    <div class="logo">
      <span class="logo-icon">F</span>
      <span class="logo-text">FATISCO</span>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
  </div>
</div>

<div class="container">
  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="totalEmails">0</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="validEmails">0</div>
      <div class="stat-label">Valid</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="emailsSentToday">0</div>
      <div class="stat-label">Sent Today</div>
      <div class="time-info" id="todayInfo">Since midnight</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="emailsSentTotal">0</div>
      <div class="stat-label">Sent (Total)</div>
    </div>
  </div>

  <!-- Email List Card -->
  <div class="card">
    <div class="card-header">
      <span class="card-icon">üìß</span>
      <span class="card-title">Email List</span>
    </div>
    <div class="card-body">
      <div class="file-upload">
        <input type="file" id="fileInput" class="file-input" accept=".csv,.txt">
        <label for="fileInput" class="file-label">
          üìÅ Upload CSV/TXT
        </label>
      </div>
      
      <div class="input-group">
        <label class="label">Paste Emails (email,name,company)</label>
        <textarea class="textarea" id="list" placeholder="john@acme.com,John Doe,Acme Corp
jane@startup.io,Jane Smith,Startup Inc
bob@tech.ng,Bob Johnson,Tech Nigeria"></textarea>
      </div>
      
      <div class="button-group">
        <button class="btn btn-secondary" onclick="cleanList()">üßπ Clean</button>
        <button class="btn btn-secondary" onclick="forceSave()">üíæ Save</button>
        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear</button>
      </div>
    </div>
  </div>

  <!-- Email Composer Card -->
  <div class="card">
    <div class="card-header">
      <span class="card-icon">‚úâÔ∏è</span>
      <span class="card-title">Email Composer</span>
    </div>
    <div class="card-body">
      <div class="input-group">
        <label class="label">Subject Line</label>
        <input class="input" id="subject" value="Opportunity for {company}">
      </div>
      
      <div class="input-group">
        <label class="label">Message Body</label>
        <textarea class="textarea" id="body" rows="6">Hi {name},

I noticed {company} is doing great work. I'd love to discuss collaboration opportunities.

Looking forward to connecting!</textarea>
      </div>
      
      <div class="button-group">
        <button class="btn btn-primary" onclick="generateLinks()">
          ‚ö° Generate Links
        </button>
        <button class="btn btn-secondary" onclick="downloadCSV()">
          üì• Export CSV
        </button>
      </div>
    </div>
  </div>

  <!-- Email Output -->
  <div class="email-list-container" id="outputContainer">
    <div class="email-list-header">
      <div class="email-filters">
        <button class="filter-btn active" onclick="filterEmails('all')">
          All <span class="filter-count" id="countAll">0</span>
        </button>
        <button class="filter-btn" onclick="filterEmails('pending')">
          Pending <span class="filter-count" id="countPending">0</span>
        </button>
        <button class="filter-btn" onclick="filterEmails('sent')">
          Sent <span class="filter-count" id="countSent">0</span>
        </button>
      </div>
    </div>
    <div class="email-list" id="output">
      <!-- Email links will appear here -->
    </div>
  </div>
</div>

<!-- Scroll Buttons -->
<button class="scroll-btn scroll-top" onclick="scrollToTop()" id="scrollTopBtn">‚Üë</button>
<button class="scroll-btn scroll-bottom" onclick="scrollToBottom()" id="scrollBottomBtn">‚Üì</button>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Footer -->
<div class="footer">
  <div>Built by Fatai Ajani | FATISCO ¬© 2026</div>
</div>

<script>
// Core Data
let stats = {
  total: 0,
  valid: 0,
  sentToday: 0,
  sentTotal: 0
};

let emailData = {}; // Store email data for quick access
let currentFilter = 'all';

// ============================================
// INDESTRUCTIBLE "SENT TODAY" COUNTER
// ============================================

// Storage Keys - PERMANENT "SENT TODAY" COUNTER
const INDESTRUCTIBLE_KEYS = {
  SENT_TODAY: 'fatisco_indestructible_sent_today', // NEVER deleted by user
  SENT_TODAY_DATE: 'fatisco_indestructible_sent_today_date' // Date check
};

// Regular storage keys (can be cleared)
const STORAGE_KEYS = {
  EMAIL_LIST: 'fatisco_email_list',
  SUBJECT: 'fatisco_subject',
  BODY: 'fatisco_body',
  SENT_TOTAL: 'fatisco_sent_total', // CAN be cleared
  THEME: 'fatisco_theme'
};

// Load ALL data
function loadAllData() {
  try {
    // Load theme
    const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME);
    if (savedTheme === 'dark') {
      document.body.classList.add('dark');
      document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
    }
    
    // Load email list
    const savedList = localStorage.getItem(STORAGE_KEYS.EMAIL_LIST);
    if (savedList) {
      document.getElementById('list').value = savedList;
    }
    
    // Load subject and body
    const savedSubject = localStorage.getItem(STORAGE_KEYS.SUBJECT);
    if (savedSubject) document.getElementById('subject').value = savedSubject;
    
    const savedBody = localStorage.getItem(STORAGE_KEYS.BODY);
    if (savedBody) document.getElementById('body').value = savedBody;
    
    // Update stats
    updateStatsFromList();
    updateSentStats();
    
    console.log('Data loaded - Sent Today counter is indestructible');
    
  } catch (e) {
    console.error('Error loading data:', e);
  }
}

// Helper: Get today's date string
function getTodayDateString() {
  return new Date().toDateString(); // "Mon Jan 01 2024"
}

// Helper: Get today's midnight timestamp
function getTodayMidnight() {
  const now = new Date();
  const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  return midnight.getTime();
}

// Helper: Get tomorrow's midnight timestamp
function getTomorrowMidnight() {
  const now = new Date();
  const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
  return tomorrow.getTime();
}

// Helper: Get hours since midnight
function getHoursSinceMidnight() {
  const now = new Date();
  const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const hours = (now.getTime() - midnight.getTime()) / (1000 * 60 * 60);
  return Math.floor(hours);
}

// Update sent stats
function updateSentStats() {
  const todayDate = getTodayDateString();
  
  // ====================================
  // INDESTRUCTIBLE "SENT TODAY" COUNTER
  // ====================================
  let sentTodayCount = 0;
  try {
    // Check if we have saved date
    const savedDate = localStorage.getItem(INDESTRUCTIBLE_KEYS.SENT_TODAY_DATE);
    
    if (savedDate === todayDate) {
      // Same day - load the counter
      const savedCount = localStorage.getItem(INDESTRUCTIBLE_KEYS.SENT_TODAY);
      sentTodayCount = parseInt(savedCount) || 0;
    } else {
      // New day - reset counter
      sentTodayCount = 0;
      localStorage.setItem(INDESTRUCTIBLE_KEYS.SENT_TODAY, '0');
      localStorage.setItem(INDESTRUCTIBLE_KEYS.SENT_TODAY_DATE, todayDate);
      console.log('New day - Sent Today counter reset to 0');
    }
  } catch (e) {
    console.error('Error loading Sent Today counter:', e);
  }
  
  // ====================================
  // REGULAR "SENT TOTAL" COUNTER (can be cleared)
  // ====================================
  let sentTotalCount = 0;
  try {
    const savedTotal = localStorage.getItem(STORAGE_KEYS.SENT_TOTAL);
    if (savedTotal) {
      sentTotalCount = parseInt(savedTotal) || 0;
    }
  } catch (e) {
    console.error('Error loading Sent Total:', e);
  }
  
  // Update stats
  stats.sentToday = sentTodayCount;
  stats.sentTotal = sentTotalCount;
  
  document.getElementById('emailsSentToday').textContent = stats.sentToday;
  document.getElementById('emailsSentTotal').textContent = stats.sentTotal;
  
  // Update time info
  const hours = getHoursSinceMidnight();
  document.getElementById('todayInfo').textContent = `${hours}h since midnight`;
  
  console.log(`Stats: Today=${sentTodayCount}, Total=${sentTotalCount}`);
}

// Increment counters when email is sent
function incrementSentCounters() {
  const todayDate = getTodayDateString();
  
  try {
    // ====================================
    // 1. INDESTRUCTIBLE "SENT TODAY" COUNTER
    // ====================================
    let sentTodayCount = 0;
    const savedDate = localStorage.getItem(INDESTRUCTIBLE_KEYS.SENT_TODAY_DATE);
    
    if (savedDate === todayDate) {
      // Same day - increment
      const savedCount = localStorage.getItem(INDESTRUCTIBLE_KEYS.SENT_TODAY);
      sentTodayCount = parseInt(savedCount) || 0;
      sentTodayCount++;
    } else {
      // New day - start fresh
      sentTodayCount = 1;
      localStorage.setItem(INDESTRUCTIBLE_KEYS.SENT_TODAY_DATE, todayDate);
    }
    
    localStorage.setItem(INDESTRUCTIBLE_KEYS.SENT_TODAY, sentTodayCount.toString());
    
    // ====================================
    // 2. REGULAR "SENT TOTAL" COUNTER (can be cleared)
    // ====================================
    let sentTotalCount = 0;
    const savedTotal = localStorage.getItem(STORAGE_KEYS.SENT_TOTAL);
    if (savedTotal) {
      sentTotalCount = parseInt(savedTotal) || 0;
    }
    sentTotalCount++;
    localStorage.setItem(STORAGE_KEYS.SENT_TOTAL, sentTotalCount.toString());
    
    console.log(`Counters updated: Today=${sentTodayCount}, Total=${sentTotalCount}`);
    return true;
    
  } catch (e) {
    console.error('Error updating counters:', e);
    return false;
  }
}

// Save regular data
function saveData() {
  try {
    localStorage.setItem(STORAGE_KEYS.EMAIL_LIST, document.getElementById('list').value);
    localStorage.setItem(STORAGE_KEYS.SUBJECT, document.getElementById('subject').value);
    localStorage.setItem(STORAGE_KEYS.BODY, document.getElementById('body').value);
    return true;
  } catch (e) {
    console.error('Save error:', e);
    return false;
  }
}

// Theme toggle
function toggleTheme() {
  const isDark = document.body.classList.toggle('dark');
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem(STORAGE_KEYS.THEME, isDark ? 'dark' : 'light');
}

// Update stats from email list
function updateStatsFromList() {
  const list = document.getElementById('list').value;
  const lines = list.split('\n').filter(line => line.trim());
  
  let validCount = 0;
  lines.forEach(line => {
    const email = line.split(',')[0]?.trim();
    if (email && email.includes('@') && email.includes('.')) {
      validCount++;
    }
  });
  
  stats.total = lines.length;
  stats.valid = validCount;
  
  document.getElementById('totalEmails').textContent = stats.total;
  document.getElementById('validEmails').textContent = stats.valid;
}

// Clean list
function cleanList() {
  let lines = document.getElementById('list').value.split('\n').filter(line => line.trim());
  const originalCount = lines.length;
  
  const uniqueLines = [];
  const seen = new Set();
  
  lines.forEach(line => {
    const email = line.split(',')[0]?.trim().toLowerCase();
    if (email && !seen.has(email)) {
      seen.add(email);
      uniqueLines.push(line);
    }
  });
  
  document.getElementById('list').value = uniqueLines.join('\n');
  updateStatsFromList();
  saveData();
  
  showToast(`Cleaned: ${originalCount - uniqueLines.length} duplicates removed`);
}

// Force save
function forceSave() {
  if (saveData()) {
    showToast('Data saved successfully');
  } else {
    showToast('Save failed');
  }
}

// Clear all data (but NOT "Sent Today" counter!)
function clearAllData() {
  if (confirm('Clear ALL editable data?\n\n‚ö†Ô∏è NOTE: "Sent Today" counter will NOT be cleared.\nIt is indestructible and only resets at midnight.\n"Sent (Total)" will be reset.')) {
    // Clear only editable data
    document.getElementById('list').value = '';
    document.getElementById('subject').value = 'Opportunity for {company}';
    document.getElementById('body').value = 'Hi {name},\n\nI noticed {company} is doing great work. I\'d love to discuss collaboration opportunities.\n\nLooking forward to connecting!';
    document.getElementById('output').innerHTML = '';
    document.getElementById('outputContainer').style.display = 'none';
    
    emailData = {};
    updateStatsFromList();
    updateFilterCounts();
    
    // Clear regular storage (NOT indestructible counters!)
    Object.keys(localStorage).forEach(key => {
      // PRESERVE indestructible counters
      if (key === INDESTRUCTIBLE_KEYS.SENT_TODAY || 
          key === INDESTRUCTIBLE_KEYS.SENT_TODAY_DATE) {
        return; // Skip - do NOT delete
      }
      
      // Delete everything else with fatisco_ prefix
      if (key.startsWith('fatisco_')) {
        localStorage.removeItem(key);
      }
    });
    
    // Update stats to reflect cleared data
    updateSentStats();
    
    showToast('Editable data cleared\n"Sent Today" counter preserved\n"Sent (Total)" reset');
  }
}

// Parse email line
function parseLine(line) {
  const parts = line.split(',').map(p => p.trim());
  const email = parts[0];
  if (!email || !email.includes('@')) return null;
  
  let name = parts[1] || email.split('@')[0];
  let company = parts[2] || email.split('@')[1]?.split('.')[0] || 'Company';
  
  name = name.split(' ').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
  
  company = company.charAt(0).toUpperCase() + company.slice(1);
  
  return { email: email.toLowerCase(), name, company };
}

// Generate email links
function generateLinks() {
  const list = document.getElementById('list').value.trim();
  if (!list) {
    showToast('Please add emails first');
    return;
  }
  
  const lines = list.split('\n').filter(line => line.trim());
  const output = document.getElementById('output');
  const container = document.getElementById('outputContainer');
  
  output.innerHTML = '';
  emailData = {};
  container.style.display = 'block';
  
  lines.forEach((line, index) => {
    const parsed = parseLine(line);
    if (!parsed) return;
    
    // Store email data
    emailData[parsed.email] = {
      name: parsed.name,
      company: parsed.company,
      index: index
    };
    
    const subject = document.getElementById('subject').value
      .replace(/{name}/g, parsed.name)
      .replace(/{company}/g, parsed.company);
    
    const body = document.getElementById('body').value
      .replace(/{name}/g, parsed.name)
      .replace(/{company}/g, parsed.company);
    
    const mailtoLink = `mailto:${parsed.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    const emailLink = document.createElement('div');
    emailLink.className = 'email-link';
    emailLink.setAttribute('data-email', parsed.email);
    emailLink.setAttribute('data-index', index);
    
    // For pending emails: clicking anywhere sends and opens Gmail
    emailLink.addEventListener('click', function(e) {
      if (e.target.classList.contains('email-action')) {
        return;
      }
      handleSendEmail(parsed.email, parsed.name, mailtoLink);
    });
    
    emailLink.innerHTML = `
      <div class="email-number">${index + 1}</div>
      <div class="email-content">
        <div class="email-info">
          <div class="email-name">${parsed.name}</div>
          <div class="email-address">${parsed.email}</div>
        </div>
        <button class="email-action" data-email="${parsed.email}" data-name="${parsed.name}">
          Send
        </button>
      </div>
    `;
    
    output.appendChild(emailLink);
  });
  
  // Add event listeners to send buttons
  attachSendButtonListeners();
  
  updateFilterCounts();
  showToast(`Generated ${lines.length} email links`);
  
  // Show scroll buttons
  document.getElementById('scrollTopBtn').style.display = 'flex';
  document.getElementById('scrollBottomBtn').style.display = 'flex';
}

// Attach event listeners to send buttons
function attachSendButtonListeners() {
  document.querySelectorAll('.email-action').forEach(button => {
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
  });
  
  document.querySelectorAll('.email-action').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const email = this.getAttribute('data-email');
      const name = this.getAttribute('data-name');
      const emailLink = this.closest('.email-link');
      
      // Get mailto link
      const subject = document.getElementById('subject').value
        .replace(/{name}/g, name)
        .replace(/{company}/g, emailData[email]?.company || 'Company');
      
      const body = document.getElementById('body').value
        .replace(/{name}/g, name)
        .replace(/{company}/g, emailData[email]?.company || 'Company');
      
      const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      
      handleSendEmail(email, name, mailtoLink);
    });
  });
}

// Handle sending email
function handleSendEmail(email, name, mailtoLink) {
  console.log('Sending email:', email);
  
  // Update counters
  if (!incrementSentCounters()) {
    showToast('Error updating counters');
    return;
  }
  
  // Update UI immediately
  updateEmailUI(email);
  
  // Update stats and counters
  updateSentStats();
  updateFilterCounts();
  
  // Apply current filter immediately
  applyCurrentFilter();
  
  // Save regular data
  saveData();
  
  // Open Gmail in new tab
  setTimeout(() => {
    window.open(mailtoLink, '_blank');
  }, 100);
  
  showToast(`Opening Gmail for ${name}`);
}

// Update email UI
function updateEmailUI(email) {
  const emailLink = document.querySelector(`[data-email="${email}"]`);
  if (!emailLink) return;
  
  const name = emailData[email]?.name || 'Contact';
  
  // Add sent class
  emailLink.classList.add('sent');
  
  // Update number badge
  const numberBadge = emailLink.querySelector('.email-number');
  if (numberBadge) {
    numberBadge.style.background = '#10b981';
  }
  
  // Update button
  const button = emailLink.querySelector('.email-action');
  if (button) {
    button.textContent = '‚úì Sent';
    button.style.background = '#10b981';
    button.style.cursor = 'default';
    
    button.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      showToast(`Already sent to ${name} (cannot resend)`);
    };
  }
  
  // Remove existing click handler and add new one
  const newEmailLink = emailLink.cloneNode(true);
  emailLink.parentNode.replaceChild(newEmailLink, emailLink);
  
  // For sent emails: clicking shows message, NO Gmail
  newEmailLink.addEventListener('click', function(e) {
    e.preventDefault();
    if (!e.target.classList.contains('email-action')) {
      showToast(`Already sent to ${name} (cannot resend)`);
    }
  });
}

// Apply current filter
function applyCurrentFilter() {
  const emailLinks = document.querySelectorAll('.email-link');
  emailLinks.forEach(link => {
    const isSent = link.classList.contains('sent');
    
    if (currentFilter === 'all') {
      link.style.display = 'flex';
    } else if (currentFilter === 'sent') {
      link.style.display = isSent ? 'flex' : 'none';
    } else if (currentFilter === 'pending') {
      link.style.display = !isSent ? 'flex' : 'none';
    }
  });
  
  updateFilterCounts();
}

// Filter emails
function filterEmails(filter) {
  currentFilter = filter;
  
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  applyCurrentFilter();
}

// Update filter counts
function updateFilterCounts() {
  const emailLinks = document.querySelectorAll('.email-link');
  const sentCount = Array.from(emailLinks).filter(link => 
    link.classList.contains('sent')
  ).length;
  const pendingCount = emailLinks.length - sentCount;
  
  document.getElementById('countAll').textContent = emailLinks.length;
  document.getElementById('countSent').textContent = sentCount;
  document.getElementById('countPending').textContent = pendingCount;
}

// Download CSV
function downloadCSV() {
  const list = document.getElementById('list').value.trim();
  if (!list) {
    showToast('No data to export');
    return;
  }
  
  const lines = list.split('\n').filter(line => line.trim());
  let csv = 'Email,Name,Company,Status\n';
  
  lines.forEach(line => {
    const parsed = parseLine(line);
    if (parsed) {
      csv += `"${parsed.email}","${parsed.name}","${parsed.company}","Pending"\n`;
    }
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `fatisco_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('CSV downloaded');
}

// Scroll functions
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function scrollToBottom() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// Show/hide scroll buttons
window.addEventListener('scroll', function() {
  const scrollTop = window.pageYOffset;
  const scrollHeight = document.body.scrollHeight;
  const clientHeight = window.innerHeight;
  
  const topBtn = document.getElementById('scrollTopBtn');
  const bottomBtn = document.getElementById('scrollBottomBtn');
  
  if (scrollTop > 100) {
    topBtn.style.display = 'flex';
  } else {
    topBtn.style.display = 'none';
  }
  
  if (scrollHeight - scrollTop - clientHeight > 100) {
    bottomBtn.style.display = 'flex';
  } else {
    bottomBtn.style.display = 'none';
  }
});

// Toast notification
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// File input handler
document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('list').value = e.target.result;
    updateStatsFromList();
    saveData();
    showToast(`Loaded ${file.name}`);
  };
  reader.readAsText(file);
});

// Auto-save on input
let saveTimeout;
function scheduleSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    saveData();
  }, 1000);
}

document.getElementById('list').addEventListener('input', function() {
  updateStatsFromList();
  scheduleSave();
});

document.getElementById('subject').addEventListener('input', scheduleSave);
document.getElementById('body').addEventListener('input', scheduleSave);

// Check for midnight reset
function checkMidnightReset() {
  const now = Date.now();
  const tomorrowMidnight = getTomorrowMidnight();
  const timeUntilMidnight = tomorrowMidnight - now;
  
  setTimeout(() => {
    updateSentStats(); // This will reset Sent Today counter if new day
    checkMidnightReset();
  }, timeUntilMidnight + 1000);
  
  console.log(`Next midnight reset in ${Math.floor(timeUntilMidnight / 1000 / 60)} minutes`);
}

// Initialize
window.addEventListener('load', function() {
  loadAllData();
  
  // Update sent stats every minute
  setInterval(updateSentStats, 60000);
  
  // Setup midnight reset
  checkMidnightReset();
  
  console.log('FATISCO loaded with indestructible "Sent Today" counter');
});
</script>
</body>
</html>
